<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGITAL PURGATORY ONLINE</title>
    <style>
        /* --- GLOBAL & FONTS --- */
        body {
            background-image: url('1765490538488-019b0f6e-e405-75b7-b94b-e7f2c8919c60.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
        }

        /* --- INTRO OVERLAY (RED ALERT STYLE) --- */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .intro-box {
            width: 85%;
            max-width: 650px;
            border: 2px solid #FF3333;
            background: #0a0000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
            position: relative;
        }

        .intro-header {
            background: #FF3333;
            color: #000;
            font-weight: 900;
            text-align: center;
            padding: 8px;
            font-size: 18px;
            letter-spacing: 2px;
            animation: blinkHeader 2s infinite;
        }

        @keyframes blinkHeader {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .intro-text {
            color: #FF3333;
            padding: 25px;
            font-size: 14px;
            line-height: 1.5;
            text-transform: none;
            font-weight: bold;
            text-align: left;
            border-bottom: 1px solid #330000;
        }

        .intro-btn {
            width: 100%;
            padding: 15px;
            background: #000;
            color: #FF3333;
            border: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .intro-btn:hover {
            background: #FF3333;
            color: #000;
        }

        /* --- FLYING TEXT CONTAINER --- */
        #sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .flying-msg {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            background: black;
            padding: 5px 8px;
            border: 1px solid white;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            white-space: nowrap;
            /* Анимация пролета один раз, потом удаляем JS-ом */
            animation: floatUp linear forwards; 
        }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border: 1px solid #00FF00;
            object-fit: cover;
            background: #333;
        }

        .msg-content {
            display: flex;
            flex-direction: column;
        }

        .msg-nick {
            font-size: 10px;
            color: #00FF00;
            font-weight: bold;
            margin-bottom: 2px;
            text-transform: uppercase;
        }

        .msg-text {
            font-size: 16px;
            font-weight: bold;
            text-transform: none;
        }

        @keyframes floatUp {
            from { transform: translateY(110vh); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            to { transform: translateY(-20vh); opacity: 0; }
        }

        /* --- UI COMPONENTS --- */
        .top-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            gap: 15px;
        }

        .system-info {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            background: #000;
            border: 1px solid #fff;
            padding: 10px;
            color: #fff;
            font-size: 12px;
            box-shadow: -4px 4px 0px #0000AA;
            text-align: right;
            max-width: 200px;
        }

        .sys-row { margin-bottom: 5px; }
        .sys-label { color: #888; }
        .sys-val { color: #00FF00; font-weight: bold; }

        .retro-btn {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 8px 12px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 4px 4px 0px #555;
            transition: all 0.1s;
            text-transform: uppercase;
        }

        .retro-btn:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #555;
            background: #0000AA;
        }

        .retro-btn:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }

        /* --- INPUT PANEL --- */
        .input-wrapper {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            width: 90%;
            max-width: 500px;
            background: #000;
            border: 2px solid #fff;
            padding: 10px;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.8);
        }

        .input-header {
            background: #fff;
            color: #000;
            font-weight: 900;
            text-align: center;
            padding: 2px 0;
            margin-bottom: 8px;
            letter-spacing: 1px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .user-config {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .label-small {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 2px;
            text-transform: uppercase;
        }

        input[type="text"] {
            background: #222;
            border: 1px solid #fff;
            color: #fff;
            padding: 5px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            outline: none;
        }

        .main-input {
            width: 100%;
            box-sizing: border-box;
            background: #0000AA !important;
            color: #00FF00 !important;
            font-size: 16px !important;
            font-weight: bold;
            padding: 10px !important;
            border: 2px solid #fff !important;
        }

        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .send-btn {
            background: #fff;
            color: #000;
            border: 2px solid #fff;
            padding: 5px 20px;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .send-btn:hover {
            background: #000;
            color: #fff;
        }

    </style>
</head>
<body>

    <!-- ПРЕДУПРЕЖДЕНИЕ -->
    <div id="intro-overlay">
        <div class="intro-box">
            <div class="intro-header">/// WARNING: ETHICS PROTOCOL REQUIRED ///</div>
            <div class="intro-text">
                I understand that you visited this page knowing that there would be an input field and that you are free to write whatever you want, but don't be an idiot. I understand how you want to write about how niggers are trash, or how some government deserves to collapse or fall apart, or how you're a fucking script kiddie and want to do an XSS injection, but let's stick to ethics and do without that. I'm afraid that in 40 years, when your sons or grandsons see this, you won't like your reaction or the fact that everyone will remember you like this. Peace and good to you.
            </div>
            <button class="intro-btn" onclick="enterSite()">[ ACKNOWLEDGE & PROCEED ]</button>
        </div>
    </div>

    <div id="sky"></div>

    <div class="top-ui">
        <button class="retro-btn" onclick="history.back()">&lt; BACK</button>
        <button class="retro-btn" id="soundBtn">[ MUTE ]</button>
    </div>

    <div class="system-info">
        <div class="input-header">:: SYSTEM MONITOR ::</div>
        <div class="sys-row">
            <span class="sys-label">IP_ADDR:</span><br>
            <span class="sys-val" id="ipDisplay">LOADING...</span>
        </div>
        <div class="sys-row">
            <span class="sys-label">USER_AGENT:</span><br>
            <span class="sys-val" style="font-size: 10px;" id="uaDisplay">UNKNOWN</span>
        </div>
        <div class="sys-row">
            <span class="sys-label">DB_STATUS:</span><br>
            <span class="sys-val" id="dbStatus" style="color: yellow;">CONNECTING...</span>
        </div>
        <div class="sys-row">
            <span class="sys-label">CACHE_SIZE:</span><br>
            <span class="sys-val" id="cacheSize">0</span>
        </div>
    </div>

    <audio id="bgMusic" loop>
        <source src="mp3/nature-216798.mp3" type="audio/mpeg">
    </audio>

    <div class="input-wrapper">
        <div class="input-header">:: COMMUNICATOR v3.0 ::</div>
        
        <div class="user-config">
            <div class="input-group" style="flex: 1;">
                <span class="label-small">CODENAME (NICK)</span>
                <input id="nickInput" type="text" placeholder="GUEST">
            </div>
            <div class="input-group" style="flex: 2;">
                <span class="label-small">AVATAR URL (IMG)</span>
                <input id="avatarInput" type="text" placeholder="https://...">
            </div>
        </div>

        <input id="messageInput" class="main-input" type="text" placeholder="ENTER MESSAGE..." autocomplete="off">
        
        <div class="action-row">
            <button class="send-btn" onclick="sendMessage()">[ TRANSMIT ]</button>
            <div style="font-size: 10px; color: #fff;">SECURE_CONNECTION: TRUE</div>
        </div>
    </div>

    <!-- ПОДКЛЮЧЕНИЕ FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // !!! ВСТАВЬ СЮДА ДАННЫЕ ИЗ FIREBASE !!!
        const firebaseConfig = {
            apiKey: "ВСТАВЬ_СВОЙ_API_KEY",
            authDomain: "ТВОЙ_ПРОЕКТ.firebaseapp.com",
            databaseURL: "https://ТВОЙ_ПРОЕКТ-default-rtdb.firebaseio.com",
            projectId: "ТВОЙ_ПРОЕКТ",
            storageBucket: "ТВОЙ_ПРОЕКТ.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            document.getElementById('dbStatus').textContent = "ONLINE";
            document.getElementById('dbStatus').style.color = "#00FF00";
        } catch (e) {
            console.error("Firebase init error:", e);
            document.getElementById('dbStatus').textContent = "ERROR";
            document.getElementById('dbStatus').style.color = "red";
        }

        const messagesRef = ref(db, 'messages');

        // --- ЛОГИКА "ДОЖДЯ ИЗ СООБЩЕНИЙ" ---
        const messageCache = []; // Хранилище всех загруженных сообщений
        const sky = document.getElementById('sky');

        // Функция визуального спавна
        function spawnMessage(msgData, immediate = false) {
            const div = document.createElement('div');
            div.className = 'flying-msg';

            const avatarUrl = msgData.avatar && msgData.avatar.length > 10 
                ? msgData.avatar 
                : 'https://cdn-icons-png.flaticon.com/512/266/266033.png';

            const nickName = msgData.nick || 'UNKNOWN';

            div.innerHTML = `
                <img src="${avatarUrl}" class="msg-avatar" onerror="this.src='https://cdn-icons-png.flaticon.com/512/266/266033.png'">
                <div class="msg-content">
                    <div class="msg-nick">${escapeHtml(nickName)}</div>
                    <div class="msg-text">${escapeHtml(msgData.text)}</div>
                </div>
            `;

            // Рандомная позиция
            div.style.left = (Math.random() * 80 + 5) + '%';
            
            // Скорость полета (от 10 до 20 секунд)
            const duration = Math.random() * 10 + 10; 
            div.style.animationDuration = duration + 's';

            sky.appendChild(div);
            
            // Удаляем элемент после того как он улетел (чтобы браузер не завис)
            setTimeout(() => {
                div.remove();
            }, duration * 1000); 
        }

        // 1. Слушаем базу и просто пополняем кэш
        onChildAdded(messagesRef, (snapshot) => {
            const data = snapshot.val();
            messageCache.push(data);
            
            // Обновляем счетчик
            document.getElementById('cacheSize').textContent = messageCache.length;

            // Если сообщение "свежее" (написано только что, меньше 10 секунд назад),
            // запускаем его сразу вне очереди, чтобы автор его увидел.
            const now = Date.now();
            const msgTime = data.timestamp || 0;
            if (now - msgTime < 10000) {
                spawnMessage(data);
            }
        });

        // 2. ГЕНЕРАТОР ПОТОКА (САМОЕ ВАЖНОЕ)
        // Каждые 800мс берем случайное сообщение из памяти и запускаем его
        setInterval(() => {
            if (messageCache.length > 0) {
                // Берем случайное
                const randomMsg = messageCache[Math.floor(Math.random() * messageCache.length)];
                
                // Чтобы не перегрузить экран, проверяем сколько сейчас элементов
                if (document.getElementsByClassName('flying-msg').length < 30) {
                    spawnMessage(randomMsg);
                }
            }
        }, 800);

        // --- ОТПРАВКА ---
        window.sendMessage = function() {
            const input = document.getElementById('messageInput');
            const nickInput = document.getElementById('nickInput');
            const avatarInput = document.getElementById('avatarInput');

            const text = input.value.trim();
            const nick = nickInput.value.trim() || 'ANONYMOUS';
            const avatar = avatarInput.value.trim();
            
            if (text) {
                push(messagesRef, {
                    text: text,
                    nick: nick,
                    avatar: avatar,
                    timestamp: serverTimestamp()
                });
                
                localStorage.setItem('user_nick', nick);
                localStorage.setItem('user_avatar', avatar);
                
                input.value = '';
                input.focus();
            }
        }

        function escapeHtml(text) {
            if(!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.sendMessage();
        });

        document.getElementById('nickInput').value = localStorage.getItem('user_nick') || '';
        document.getElementById('avatarInput').value = localStorage.getItem('user_avatar') || '';

        // Global exports
        window.enterSite = function() {
            const overlay = document.getElementById('intro-overlay');
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.8s';
            setTimeout(() => { overlay.style.display = 'none'; }, 800);
        }

        const audio = document.getElementById('bgMusic');
        const soundBtn = document.getElementById('soundBtn');
        soundBtn.onclick = () => {
            if (audio.paused) {
                audio.play();
                soundBtn.textContent = '[ SOUND: ON ]';
                soundBtn.style.color = '#00FF00';
            } else {
                audio.pause();
                soundBtn.textContent = '[ SOUND: OFF ]';
                soundBtn.style.color = '#fff';
            }
        };

        document.getElementById('uaDisplay').textContent = navigator.platform;
        fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => document.getElementById('ipDisplay').textContent = data.ip)
            .catch(() => document.getElementById('ipDisplay').textContent = "HIDDEN");
    </script>
</body>
</html>